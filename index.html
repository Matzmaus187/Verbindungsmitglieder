<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Verbindungsmitglieder</title>
  <style>
    body{font-family:system-ui,Arial;margin:0;background:#0b1220;color:#e8eefc}
    .wrap{max-width:980px;margin:0 auto;padding:24px 16px}
    .card{background:#121b31;border:1px solid rgba(255,255,255,.08);border-radius:16px;padding:16px;margin:12px 0}
    input,select,button{padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,.15);background:#0f1730;color:#e8eefc}
    button{cursor:pointer}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:12px}
    img.avatar{width:72px;height:72px;border-radius:50%;object-fit:cover}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .muted{opacity:.8}
    .badge{display:inline-block;padding:4px 8px;border-radius:999px;background:rgba(255,255,255,.08);font-size:12px}
  </style>
</head>
<body>
<div class="wrap">
  <h1>Verbindungsmitglieder</h1>
  <div id="app"></div>
</div>

<script type="module">
  import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";

  // TODO: HIER eintragen
  const SUPABASE_URL = "https://uiwztqdilqtzsjnjlybz.supabase.co";
  const SUPABASE_ANON_KEY = "sb_publishable_FDMe4IDkDo8ldu8mNmpF9A_0F50nWf5";
  const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  const app = document.getElementById("app");
  const LS_KEY = "vm_selected_member_id";

  function render(html){ app.innerHTML = html; }

  async function listMembers(){
    const { data, error } = await supabase
      .from("members")
      .select("*")
      .order("created_at", { ascending: false });
    if (error) throw error;
    return data ?? [];
  }

  async function createMember({name, beer_name, job, join_semester, avatar_url}){
    const { data, error } = await supabase
      .from("members")
      .insert({ name, beer_name, job, join_semester, avatar_url })
      .select()
      .single();
    if (error) throw error;
    return data;
  }

  function startView(){
    render(`
      <div class="card">
        <h2>Willkommen</h2>
        <p class="muted">Wähle dein Profil aus oder erstelle ein neues.</p>
        <div class="row">
          <button id="goPick">Ich bin schon in der Liste</button>
          <button id="goCreate">Neuen Charakter erstellen</button>
        </div>
      </div>
    `);

    document.getElementById("goPick").onclick = pickView;
    document.getElementById("goCreate").onclick = createView;
  }

  async function pickView(){
    render(`
      <div class="card">
        <h2>Profil auswählen</h2>
        <p class="muted">Wähle deinen Namen aus der Liste.</p>
        <div class="row">
          <select id="memberSelect" style="min-width:260px"></select>
          <button id="continue">Weiter</button>
          <button id="back">Zurück</button>
        </div>
        <p id="msg" class="muted"></p>
      </div>
    `);

    document.getElementById("back").onclick = startView;

    const sel = document.getElementById("memberSelect");
    const msg = document.getElementById("msg");

    try {
      const all = await listMembers();
      if(all.length === 0){
        msg.textContent = "Noch keine Mitglieder vorhanden. Bitte erstelle zuerst ein Profil.";
        return;
      }
      sel.innerHTML = all.map(m => `<option value="${m.id}">${m.name} („${m.beer_name}“)</option>`).join("");

      document.getElementById("continue").onclick = () => {
        const id = sel.value;
        localStorage.setItem(LS_KEY, id);
        directoryView();
      };
    } catch(e){
      msg.textContent = "Fehler: " + e.message;
    }
  }

  function createView(){
    render(`
      <div class="card">
        <h2>Charakter erstellen</h2>
        <div class="row">
          <input id="name" placeholder="Name" />
          <input id="beer" placeholder="Biername" />
          <input id="job" placeholder="Beruf" />
          <input id="sem" placeholder="Beitrittssemester (z.B. WS 25/26)" />
        </div>
        <div class="row">
          <input id="avatar" type="file" accept="image/*" />
          <button id="save">Speichern</button>
          <button id="back">Zurück</button>
        </div>
        <p id="msg" class="muted"></p>
        <p class="muted" style="font-size:12px;">Hinweis: “Login per Name” ist nur eine Auswahl, kein echter Schutz.</p>
      </div>
    `);

    document.getElementById("back").onclick = startView;

    document.getElementById("save").onclick = async () => {
      const msg = document.getElementById("msg");
      msg.textContent = "";

      const name = document.getElementById("name").value.trim();
      const beer_name = document.getElementById("beer").value.trim();
      const job = document.getElementById("job").value.trim();
      const join_semester = document.getElementById("sem").value.trim();
      const file = document.getElementById("avatar").files[0];

      if(!name || !beer_name || !job || !join_semester){
        msg.textContent = "Bitte alle Felder ausfüllen.";
        return;
      }

      let avatar_url = null;

      // Optional: Bild-Upload (nur wenn du später Insert + Upload erlaubst)
      // Für super-einfach erstmal ohne Upload arbeiten:
      // avatar_url bleibt null (wir zeigen dann Platzhalter)

      // Wenn du Upload willst, sag Bescheid: wir richten Storage-Policies passend ein.

      try{
        const created = await createMember({ name, beer_name, job, join_semester, avatar_url });
        localStorage.setItem(LS_KEY, created.id);
        directoryView();
      } catch(e){
        msg.textContent = "Fehler: " + e.message;
      }
    };
  }

  async function directoryView(){
    render(`
      <div class="card">
        <div class="row" style="justify-content:space-between;">
          <div>
            <h2 style="margin:0;">Mitgliederliste</h2>
            <p class="muted" style="margin:6px 0 0;">Suche/Filter sind live.</p>
          </div>
          <div class="row">
            <button id="switch">Profil wechseln</button>
          </div>
        </div>
        <div class="row">
          <input id="q" placeholder="Suchen (Name/Biername/Beruf)..." style="flex:1;min-width:220px"/>
          <input id="fsem" placeholder="Filter Semester (z.B. WS 25/26)" />
        </div>
        <p class="muted" id="me"></p>
      </div>
      <div id="list" class="grid"></div>
    `);

    document.getElementById("switch").onclick = () => {
      localStorage.removeItem(LS_KEY);
      startView();
    };

    const selectedId = localStorage.getItem(LS_KEY);
    const meEl = document.getElementById("me");
    const listEl = document.getElementById("list");
    const qEl = document.getElementById("q");
    const semEl = document.getElementById("fsem");

    let all = [];
    try{
      all = await listMembers();
    } catch(e){
      meEl.textContent = "Fehler: " + e.message;
      return;
    }

    const me = all.find(x => x.id === selectedId);
    meEl.innerHTML = me ? `Angemeldet als: <span class="badge">${me.name} („${me.beer_name}“)</span>` : `Kein Profil ausgewählt.`;

    function renderList(){
      const q = qEl.value.trim().toLowerCase();
      const sem = semEl.value.trim().toLowerCase();

      const filtered = all.filter(p => {
        const hay = `${p.name} ${p.beer_name} ${p.job}`.toLowerCase();
        const okQ = !q || hay.includes(q);
        const okS = !sem || (p.join_semester || "").toLowerCase().includes(sem);
        return okQ && okS;
      });

      listEl.innerHTML = filtered.map(p => `
        <div class="card">
          <div class="row">
            <img class="avatar" src="${p.avatar_url || "https://via.placeholder.com/144"}" alt="">
            <div>
              <div style="font-weight:700;">${p.name}</div>
              <div class="muted">„${p.beer_name}“</div>
            </div>
          </div>
          <div class="muted" style="margin-top:10px;">${p.job}</div>
          <div class="muted">Beitritt: ${p.join_semester}</div>
        </div>
      `).join("");
    }

    qEl.oninput = renderList;
    semEl.oninput = renderList;
    renderList();
  }

  // Boot
  (async () => {
    const selectedId = localStorage.getItem(LS_KEY);
    if(selectedId) directoryView();
    else startView();
  })();
</script>
</body>
</html>
